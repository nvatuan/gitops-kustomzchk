name: Test GitOps Runner (GitHub Mode)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to comment on'
        required: true
        type: number
  pull_request:
    paths:
      - 'test/ut_github/after/services/**'

permissions:
  contents: read
  pull-requests: write

env:
  GO_VERSION: '1.22'
  KUSTOMIZE_VERSION: '5.3.0'
  CONFTEST_VERSION: '0.63.0'
  MANIFESTS_PATH: 'test/ut_github'

jobs:
  detect-changed-services:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      services: ${{ steps.detect.outputs.services }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services in test/ut_github/after/services
        id: detect
        run: |
          # Get changed files in test/ut_github/after/services/
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "^test/ut_github/after/services/" || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "services=[]" >> $GITHUB_OUTPUT
            echo "No changes in test/ut_github/after/services/"
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Extract unique service names (directory after services/)
          SERVICES=$(echo "$CHANGED_FILES" | cut -d/ -f5 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Detected services: $SERVICES"

  run-gitops-check:
    name: Run GitOps Check (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: [detect-changed-services]
    if: |
      (github.event_name == 'pull_request' && needs.detect-changed-services.outputs.has_changes == 'true') ||
      github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changed-services.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/kustomize
            /usr/local/bin/conftest
          key: tools-${{ runner.os }}-kustomize-${{ env.KUSTOMIZE_VERSION }}-conftest-${{ env.CONFTEST_VERSION }}

      - name: Install kustomize
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${{ env.KUSTOMIZE_VERSION }}/kustomize_v${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz" | tar xz
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Install conftest
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -L -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Build gitops-kustomzchk
        run: make build

      - name: Add tools to PATH
        run: |
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Determine PR number
        id: get-pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine checkout strategy based on service
        id: determine-strategy
        run: |
          SERVICE="${{ matrix.service }}"
          
          # Services that require shallow checkout (cross-service dependencies)
          # Add one service per line
          USE_SHALLOW_FOR=$(cat <<'EOF'
            my-app-shallow-clone
            serivce-shallow-1
          EOF
          )
          
          # Check if service is in the list
          if echo "$USE_SHALLOW_FOR" | grep -q "$SERVICE"; then
            STRATEGY="shallow"
          else
            STRATEGY="sparse"
          fi
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "Using checkout strategy: $STRATEGY for service: $SERVICE"

      - name: Run policy check
        id: run-gitops-kustomzchk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RUN_ID: ${{ github.run_id }}
          GITHUB_COMMENT_MAX_DIFF_LENGTH: 15000
        run: |
          ./bin/gitops-kustomzchk \
            --run-mode github \
            --git-checkout-strategy ${{ steps.determine-strategy.outputs.strategy }} \
            --gh-repo ${{ github.repository }} \
            --gh-pr-number ${{ steps.get-pr.outputs.pr_number }} \
            --manifests-path ${{ env.MANIFESTS_PATH }}/before/services \
            --service ${{ steps.determine-strategy.outputs.service }} \
            --environments stg,prod \
            --policies-path ${{ env.MANIFESTS_PATH }}/policies \
            --templates-path ${{ env.MANIFESTS_PATH }}/templates \
            --output-dir output \
            --enable-export-report true \
            --debug true
        continue-on-error: false

      - name: Upload report artifact
        if: steps.run-gitops-kustomzchk.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ steps.determine-strategy.outputs.service }}
          path: output/report.json
          retention-days: 3

      - name: Signal completion
        if: always()
        run: |
          echo "GitOps check (${{ matrix.service }}) completed with status: ${{ job.status }}"

