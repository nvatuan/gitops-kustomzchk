name: Test GitOps Runner (GitHub Mode)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to comment on'
        required: true
        type: number
  pull_request:
    paths:
      - 'test/ut_github/**'
      - 'src/**'
      - '.github/workflows/test-github-*.yml'

permissions:
  contents: read
  pull-requests: write

env:
  GO_VERSION: '1.22'
  KUSTOMIZE_VERSION: '5.3.0'
  CONFTEST_VERSION: '0.63.0'
  MANIFESTS_PATH: 'test/ut_github'

jobs:
  run-gitops-check:
    name: Run GitOps Check on PR
    runs-on: ubuntu-latest
    # Only run on workflow_dispatch OR if PR title starts with "ðŸ§ª Integration Test"
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.pull_request.title, 'ðŸ§ª Integration Test')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/kustomize
            /usr/local/bin/conftest
          key: tools-${{ runner.os }}-kustomize-${{ env.KUSTOMIZE_VERSION }}-conftest-${{ env.CONFTEST_VERSION }}

      - name: Install kustomize
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${{ env.KUSTOMIZE_VERSION }}/kustomize_v${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz" | tar xz
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Install conftest
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -L -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Build gitops-kustomzchk
        run: make build

      - name: Add tools to PATH
        run: |
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Determine PR number
        id: get-pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run policy check
        id: run-gitops-kustomzchk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RUN_ID: ${{ github.run_id }}
          GITHUB_COMMENT_MAX_DIFF_LENGTH: 15000
        run: |
          ./bin/gitops-kustomzchk \
            --run-mode github \
            --gh-repo ${{ github.repository }} \
            --gh-pr-number ${{ steps.get-pr.outputs.pr_number }} \
            --manifests-path ${{ env.MANIFESTS_PATH }} \
            --service my-app \
            --environments stg,prod \
            --policies-path ${{ env.MANIFESTS_PATH }}/policies \
            --templates-path ${{ env.MANIFESTS_PATH }}/templates \
            --output-dir output \
            --enable-export-report true \
            --debug true
        continue-on-error: false

      - name: Upload report artifact
        if: steps.run-gitops-kustomzchk.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: report-my-app
          path: output/report.json
          retention-days: 3

      - name: Signal completion
        if: always()
        run: |
          echo "GitOps check completed with status: ${{ job.status }}"

