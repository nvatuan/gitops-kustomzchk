name: Test GitOps Runner (GitHub Mode)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to comment on'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

env:
  GO_VERSION: '1.22'
  KUSTOMIZE_VERSION: '5.3.0'
  CONFTEST_VERSION: '0.63.0'
  MANIFESTS_PATH: 'test/ut_github'

jobs:
  detect-changed-services:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services_matrix: ${{ steps.detect.outputs.services_matrix }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Get PR details
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR base and head refs
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr_number }})
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "PR #${{ inputs.pr_number }}: $BASE_REF <- $HEAD_REF"

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.head_ref }}
          fetch-depth: 0

      - name: Detect changed services from PR diff
        id: detect
        run: |
          # Fetch base ref
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          
          # Get changed files between base and head
          CHANGED_FILES=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_ref }}...HEAD || echo "")
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Filter for changes in test/ut_github services (either before/ or after/)
          SERVICE_CHANGES=$(echo "$CHANGED_FILES" | grep "^test/ut_github/\(before\|after\)/services/" || echo "")
          
          if [ -z "$SERVICE_CHANGES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "services_matrix=[]" >> $GITHUB_OUTPUT
            echo "No service changes detected"
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Extract unique service names (5th field in path: test/ut_github/{before|after}/services/SERVICE_NAME/...)
          # Exclude common-configmap as it's a shared resource, not a service to test
          SERVICES=$(echo "$SERVICE_CHANGES" | cut -d/ -f5 | sort -u | grep -v "^common-configmap$")
          
          # Build matrix JSON with service-specific configurations
          MATRIX_JSON="["
          FIRST=true
          for SERVICE in $SERVICES; do
            if [ "$FIRST" = false ]; then
              MATRIX_JSON="$MATRIX_JSON,"
            fi
            FIRST=false
            
            case "$SERVICE" in
              "my-app")
                # Legacy mode
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$SERVICE\",\"mode\":\"legacy\",\"strategy\":\"sparse\",\"environments\":\"stg,prod\"}"
                ;;
              "my-app-shallow-clone")
                # Legacy mode with shallow clone
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$SERVICE\",\"mode\":\"legacy\",\"strategy\":\"shallow\",\"environments\":\"stg,prod\"}"
                ;;
              "my-app-deep-overlay")
                # Dynamic mode
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$SERVICE\",\"mode\":\"dynamic\",\"strategy\":\"sparse\",\"build_path\":\"${{ env.MANIFESTS_PATH }}/before/services/[SERVICE]/clusters/[CLUSTER]/[ENV]\",\"build_values\":\"SERVICE=$SERVICE;CLUSTER=alpha,beta;ENV=stg,prod\"}"
                ;;
              *)
                # Default: legacy mode with sparse strategy
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$SERVICE\",\"mode\":\"legacy\",\"strategy\":\"sparse\",\"environments\":\"stg,prod\"}"
                ;;
            esac
          done
          MATRIX_JSON="$MATRIX_JSON]"
          
          echo "services_matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Detected services matrix: $MATRIX_JSON"

  run-gitops-check:
    name: Run GitOps Check (${{ matrix.config.service }})
    runs-on: ubuntu-latest
    needs: [detect-changed-services]
    if: needs.detect-changed-services.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.detect-changed-services.outputs.services_matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/bin/kustomize
            /usr/local/bin/conftest
          key: tools-${{ runner.os }}-kustomize-${{ env.KUSTOMIZE_VERSION }}-conftest-${{ env.CONFTEST_VERSION }}

      - name: Install kustomize
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${{ env.KUSTOMIZE_VERSION }}/kustomize_v${{ env.KUSTOMIZE_VERSION }}_linux_amd64.tar.gz" | tar xz
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Install conftest
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          curl -L -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Build gitops-kustomzchk
        run: make build

      - name: Add tools to PATH
        run: |
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Determine PR number
        id: get-pr
        run: |
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT

      - name: Run policy check (legacy mode)
        if: matrix.config.mode == 'legacy'
        id: run-legacy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RUN_ID: ${{ github.run_id }}
          GITHUB_COMMENT_MAX_DIFF_LENGTH: 15000
        run: |
          ./bin/gitops-kustomzchk \
            --run-mode github \
            --git-checkout-strategy ${{ matrix.config.strategy }} \
            --gh-repo ${{ github.repository }} \
            --gh-pr-number ${{ steps.get-pr.outputs.pr_number }} \
            --manifests-path ${{ env.MANIFESTS_PATH }}/before/services \
            --service ${{ matrix.config.service }} \
            --environments ${{ matrix.config.environments }} \
            --policies-path ${{ env.MANIFESTS_PATH }}/policies \
            --templates-path ${{ env.MANIFESTS_PATH }}/templates \
            --output-dir output \
            --enable-export-report true \
            --debug true
        continue-on-error: false

      - name: Run policy check (dynamic mode)
        if: matrix.config.mode == 'dynamic'
        id: run-dynamic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RUN_ID: ${{ github.run_id }}
          GITHUB_COMMENT_MAX_DIFF_LENGTH: 15000
        run: |
          ./bin/gitops-kustomzchk \
            --run-mode github \
            --git-checkout-strategy ${{ matrix.config.strategy }} \
            --gh-repo ${{ github.repository }} \
            --gh-pr-number ${{ steps.get-pr.outputs.pr_number }} \
            --kustomize-build-path "${{ matrix.config.build_path }}" \
            --kustomize-build-values "${{ matrix.config.build_values }}" \
            --policies-path ${{ env.MANIFESTS_PATH }}/policies \
            --templates-path ${{ env.MANIFESTS_PATH }}/templates \
            --output-dir output \
            --enable-export-report true \
            --debug true
        continue-on-error: false

      - name: Upload report artifact
        if: steps.run-legacy.outcome == 'success' || steps.run-dynamic.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.config.service }}
          path: output/report.json
          retention-days: 3

      - name: Signal completion
        if: always()
        run: |
          echo "GitOps check (${{ matrix.config.service }}) completed with status: ${{ job.status }}"

